name: Accessibility & Launch Readiness Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1" # Mondays 10:00 AM ET (14:00 UTC)

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate readiness report
        shell: bash
        run: |
          set -u
          mkdir -p reports/readiness

          REPORT="reports/readiness/latest.md"
          NOW="$(date -u '+%Y-%m-%d %H:%M UTC')"

          {
            echo "# Readiness Report"
            echo ""
            echo "- Generated: ${NOW}"
            echo "- Repo: ${GITHUB_REPOSITORY}"
            echo "- Branch: ${GITHUB_REF_NAME}"
            echo ""
            echo "## Core file checks"
            echo ""
          } > "$REPORT"

          files=("index.html" "README.md" "SECURITY.md" "accessibility.md")
          for f in "${files[@]}"; do
            if [[ -f "$f" ]]; then
              echo "- ✅ $f" >> "$REPORT"
            else
              echo "- ⚠️ Missing: $f" >> "$REPORT"
            fi
          done

          {
            echo ""
            echo "## Core path checks"
            echo ""
          } >> "$REPORT"

          dirs=("text" "dashboard" "reports" "series" "accessibility-ministry")
          for d in "${dirs[@]}"; do
            if [[ -e "$d" ]]; then
              echo "- ✅ $d" >> "$REPORT"
            else
              echo "- ⚠️ Missing: $d" >> "$REPORT"
            fi
          done

          echo "" >> "$REPORT"
          echo "## Notes" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "- If any items are missing, restore them before major updates or releases." >> "$REPORT"

          echo "Report created at $REPORT"
          echo "REPORT_PATH=$REPORT" >> "$GITHUB_ENV"

      # A) Backup: upload as artifact (safest)
      - name: Upload readiness report (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: readiness-report
          path: ${{ env.REPORT_PATH }}

      # B) Convenience: publish to repo (best usability)
      # If branch protections block direct commits, artifact still exists.
      - name: Publish readiness report to repo
        shell: bash
        run: |
          git config user.name "jtj-readiness-bot"
          git config user.email "actions@users.noreply.github.com"

          git add "${{ env.REPORT_PATH }}"

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git commit -m "Update readiness report"
          git push origin HEAD
